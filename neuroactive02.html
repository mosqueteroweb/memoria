<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NeuroActive 2.2 - Universal</title>
    
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Carga de Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Carga de SQL.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>

    <!-- Configuraci√≥n de Tailwind -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'neuro-primary': '#2563EB',
                        'neuro-secondary': '#10B981',
                        'neuro-accent': '#F59E0B',
                        'neuro-danger': '#EF4444',
                        'neuro-purple': '#8B5CF6',
                        'neuro-bg': '#F3F4F6',
                        'neuro-card': '#FFFFFF',
                        'neuro-text': '#1F2937'
                    },
                    fontFamily: {
                        sans: ['Segoe UI', 'Roboto', 'Helvetica', 'Arial', 'sans-serif'],
                    },
                    screens: {
                        'xs': '475px', // Breakpoint extra para m√≥viles anchos
                    }
                }
            }
        }
    </script>

    <style>
        body { font-size: 18px; -webkit-tap-highlight-color: transparent; }
        .btn-neuro { transition: transform 0.1s, box-shadow 0.1s; }
        .btn-neuro:active { transform: scale(0.96); }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        /* Scroll suave y oculto est√©ticamente pero funcional */
        #app-container {
            scrollbar-width: thin;
            scrollbar-color: #CBD5E1 transparent;
        }
    </style>
</head>
<body class="bg-neuro-bg text-neuro-text h-screen flex flex-col font-sans select-none overflow-hidden">

    <!-- HEADER -->
    <header class="bg-white shadow-md p-3 md:p-4 sticky top-0 z-50 flex-none">
        <div class="max-w-4xl mx-auto flex justify-between items-center">
            <h1 class="text-xl md:text-3xl font-bold text-neuro-primary flex items-center gap-2 truncate">
                üß† NeuroActive
            </h1>
            <div id="user-badge" class="hidden flex items-center gap-2">
                <span class="text-sm md:text-base font-semibold bg-blue-100 text-blue-800 px-3 py-1 rounded-full truncate max-w-[120px]" id="header-username">Usuario</span>
                <button onclick="app.logout()" class="text-red-500 font-bold border border-red-200 px-2 py-1 rounded text-xs md:text-sm hover:bg-red-50 whitespace-nowrap">Salir</button>
            </div>
        </div>
    </header>

    <!-- MAIN CONTAINER -->
    <!-- Eliminado mb-16 fijo, ahora el padding interno de las secciones maneja el espacio del navbar -->
    <main id="app-container" class="flex-grow p-4 md:p-6 max-w-5xl mx-auto w-full overflow-y-auto relative">
        
        <!-- VISTA: LOGIN -->
        <section id="view-login" class="flex flex-col items-center justify-center min-h-[70vh] fade-in">
            <div class="bg-white p-8 rounded-3xl shadow-xl w-full max-w-md text-center border-t-8 border-neuro-primary mx-4">
                <h2 class="text-2xl md:text-3xl font-bold mb-2 text-neuro-primary">Bienvenido</h2>
                <p class="mb-8 text-gray-500">Entrenamiento cognitivo diario</p>
                
                <div class="space-y-4">
                    <input type="text" id="input-username" placeholder="¬øSu nombre?" 
                        class="w-full p-4 text-xl border-2 border-gray-200 rounded-xl focus:border-neuro-primary focus:outline-none text-center bg-gray-50">
                    
                    <button id="btn-login" class="w-full bg-neuro-primary text-white text-xl font-bold py-4 rounded-xl shadow-lg hover:bg-blue-700 btn-neuro">
                        COMENZAR
                    </button>
                </div>
                <p id="db-status" class="mt-6 text-sm text-gray-400">Sistema listo.</p>
            </div>
        </section>

        <!-- VISTA: SELECCI√ìN DE JUEGOS (HOME) -->
        <!-- pb-32 asegura que el contenido final no quede tapado por el navbar -->
        <section id="view-home" class="hidden fade-in space-y-6 pb-32">
            <div class="text-center mb-2">
                <h2 class="text-xl md:text-2xl font-bold text-gray-800">¬øQu√© desea entrenar hoy?</h2>
            </div>

            <!-- Categor√≠a: Memoria -->
            <div class="space-y-3">
                <h3 class="text-lg font-bold text-blue-600 border-b-2 border-blue-100 pb-1 px-1">üîµ Memoria Visoespacial</h3>
                <!-- Grid adaptable: 1 col en m√≥vil, 2 en tablets/pc -->
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 md:gap-4">
                    <button onclick="app.startGame('memoryMatrix')" class="bg-white p-4 rounded-2xl shadow-sm border-l-8 border-blue-500 text-left hover:shadow-md btn-neuro flex justify-between items-center group">
                        <div>
                            <div class="font-bold text-lg group-hover:text-blue-600 transition-colors">Matriz de Memoria</div>
                            <div class="text-sm text-gray-500">Recuerda las posiciones</div>
                        </div>
                        <span class="text-3xl">üß©</span>
                    </button>
                    <button onclick="app.startGame('spatialPath')" class="bg-white p-4 rounded-2xl shadow-sm border-l-8 border-blue-400 text-left hover:shadow-md btn-neuro flex justify-between items-center group">
                        <div>
                            <div class="font-bold text-lg group-hover:text-blue-500 transition-colors">Ruta Espacial</div>
                            <div class="text-sm text-gray-500">Sigue la secuencia</div>
                        </div>
                        <span class="text-3xl">üìç</span>
                    </button>
                </div>
            </div>

            <!-- Categor√≠a: Atenci√≥n -->
            <div class="space-y-3">
                <h3 class="text-lg font-bold text-green-600 border-b-2 border-green-100 pb-1 px-1">üü¢ Control y Atenci√≥n</h3>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 md:gap-4">
                    <button onclick="app.startGame('stroop')" class="bg-white p-4 rounded-2xl shadow-sm border-l-8 border-green-500 text-left hover:shadow-md btn-neuro flex justify-between items-center group">
                        <div>
                            <div class="font-bold text-lg group-hover:text-green-600 transition-colors">Colores Confusos</div>
                            <div class="text-sm text-gray-500">Inhibici√≥n (Stroop)</div>
                        </div>
                        <span class="text-3xl">üé®</span>
                    </button>
                    <button onclick="app.startGame('goNoGo')" class="bg-white p-4 rounded-2xl shadow-sm border-l-8 border-green-400 text-left hover:shadow-md btn-neuro flex justify-between items-center group">
                        <div>
                            <div class="font-bold text-lg group-hover:text-green-500 transition-colors">Sem√°foro (Go/No-Go)</div>
                            <div class="text-sm text-gray-500">Control de impulsos</div>
                        </div>
                        <span class="text-3xl">üö¶</span>
                    </button>
                </div>
            </div>

            <!-- Categor√≠a: Lenguaje -->
            <div class="space-y-3">
                <h3 class="text-lg font-bold text-yellow-600 border-b-2 border-yellow-100 pb-1 px-1">üü° Lenguaje</h3>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 md:gap-4">
                    <button onclick="app.startGame('languageOrder')" class="bg-white p-4 rounded-2xl shadow-sm border-l-8 border-yellow-500 text-left hover:shadow-md btn-neuro flex justify-between items-center group">
                        <div>
                            <div class="font-bold text-lg group-hover:text-yellow-600 transition-colors">Ordenar Frases</div>
                            <div class="text-sm text-gray-500">Sintaxis y l√≥gica</div>
                        </div>
                        <span class="text-3xl">üìù</span>
                    </button>
                    <button onclick="app.startGame('wordAssoc')" class="bg-white p-4 rounded-2xl shadow-sm border-l-8 border-yellow-400 text-left hover:shadow-md btn-neuro flex justify-between items-center group">
                        <div>
                            <div class="font-bold text-lg group-hover:text-yellow-500 transition-colors">Asociaci√≥n</div>
                            <div class="text-sm text-gray-500">Sin√≥nimos y conceptos</div>
                        </div>
                        <span class="text-3xl">üîó</span>
                    </button>
                </div>
            </div>

            <!-- Categor√≠a: Velocidad -->
            <div class="space-y-3">
                <h3 class="text-lg font-bold text-purple-600 border-b-2 border-purple-100 pb-1 px-1">üü£ Velocidad Mental</h3>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 md:gap-4">
                    <button onclick="app.startGame('symbolSearch')" class="bg-white p-4 rounded-2xl shadow-sm border-l-8 border-purple-500 text-left hover:shadow-md btn-neuro flex justify-between items-center group">
                        <div>
                            <div class="font-bold text-lg group-hover:text-purple-600 transition-colors">Caza de S√≠mbolos</div>
                            <div class="text-sm text-gray-500">Escaneo visual r√°pido</div>
                        </div>
                        <span class="text-3xl">‚ö°</span>
                    </button>
                </div>
            </div>
        </section>

        <!-- VISTA: ESTAD√çSTICAS (DASHBOARD) -->
        <section id="view-stats" class="hidden fade-in space-y-6 pb-32">
            <h2 class="text-2xl font-bold text-gray-800 text-center">Informe de Progreso</h2>
            
            <div class="bg-gradient-to-r from-blue-600 to-blue-400 rounded-2xl p-6 text-white text-center shadow-lg mx-auto max-w-md">
                <p class="text-lg opacity-90">Puntuaci√≥n Global</p>
                <div class="text-5xl font-bold mt-2" id="global-score">0</div>
                <p class="text-xs mt-2 opacity-80">Acumulado semanal</p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="bg-white p-4 rounded-2xl shadow-md">
                    <h3 class="text-lg font-bold text-gray-700 mb-2 text-center">Perfil Cognitivo</h3>
                    <div class="h-64 w-full relative">
                        <canvas id="radarChart"></canvas>
                    </div>
                </div>

                <div class="bg-white p-4 rounded-2xl shadow-md">
                    <h3 class="text-lg font-bold text-gray-700 mb-2 text-center">Actividad (7 d√≠as)</h3>
                    <div class="h-48 w-full">
                        <canvas id="lineChart"></canvas>
                    </div>
                </div>
            </div>
        </section>

        <!-- VISTA: JUEGO ACTIVO -->
        <section id="view-game" class="hidden flex flex-col h-full fade-in pb-4">
            <!-- Barra superior del juego -->
            <div class="flex-none w-full flex justify-between items-center mb-4 bg-white p-3 rounded-xl shadow-sm z-10">
                <button onclick="app.switchTab('home')" class="text-sm bg-gray-100 hover:bg-gray-200 px-3 py-2 rounded-lg font-bold text-gray-600 flex items-center gap-1 transition">
                    <span>‚¨Ö</span> Salir
                </button>
                <div class="text-lg font-bold text-neuro-primary">
                    <span id="game-score" class="text-2xl font-black">0</span> pts
                </div>
            </div>

            <!-- √Årea de juego con scroll interno si es necesario -->
            <div id="game-scroll-container" class="flex-grow overflow-y-auto flex flex-col items-center justify-start w-full pb-20">
                <div id="game-area" class="w-full max-w-md bg-white rounded-3xl shadow-inner p-4 min-h-[300px] flex flex-col items-center justify-center relative">
                    <!-- Inyecci√≥n del juego -->
                </div>
                
                <div id="game-message" class="mt-4 text-xl text-center font-bold text-gray-700 px-4 w-full min-h-[3rem]">
                    Seleccione un juego
                </div>
            </div>
        </section>

    </main>

    <!-- NAVIGATION TABS -->
    <!-- Z-50 para asegurar que siempre est√© encima -->
    <nav id="nav-tabs" class="hidden fixed bottom-0 w-full bg-white shadow-[0_-4px_15px_rgba(0,0,0,0.1)] border-t border-gray-100 flex justify-around p-2 z-50 pb-safe safe-area-bottom">
        <button onclick="app.switchTab('home')" class="flex flex-col items-center p-2 w-full text-neuro-primary transition duration-200 rounded-lg active:bg-gray-50" id="tab-home">
            <span class="text-3xl mb-1">üéÆ</span>
            <span class="text-[10px] md:text-xs font-bold uppercase tracking-wide">Juegos</span>
        </button>
        <button onclick="app.switchTab('stats')" class="flex flex-col items-center p-2 w-full text-gray-400 hover:text-neuro-primary transition duration-200 rounded-lg active:bg-gray-50" id="tab-stats">
            <span class="text-3xl mb-1">üìä</span>
            <span class="text-[10px] md:text-xs font-bold uppercase tracking-wide">Progreso</span>
        </button>
    </nav>

    <!-- SCRIPTS -->
    <script>
        const GAME_CONFIG = {
            memoryMatrix: { category: 'Memoria', label: 'Matriz' },
            spatialPath:  { category: 'Memoria', label: 'Ruta' },
            stroop:       { category: 'Atenci√≥n', label: 'Stroop' },
            goNoGo:       { category: 'Atenci√≥n', label: 'Sem√°foro' },
            languageOrder:{ category: 'Lenguaje', label: 'Frases' },
            wordAssoc:    { category: 'Lenguaje', label: 'Asociaci√≥n' },
            symbolSearch: { category: 'Velocidad', label: 'S√≠mbolos' }
        };

        class DatabaseManager {
            constructor() {
                this.db = null;
                this.SQL = null;
            }
            async init() {
                try {
                    this.SQL = await initSqlJs({ locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/${file}` });
                    const savedDb = localStorage.getItem("neuroactive_v2_db");
                    if (savedDb) {
                        this.db = new this.SQL.Database(new Uint8Array(JSON.parse(savedDb)));
                    } else {
                        this.db = new this.SQL.Database();
                        this.createTables();
                    }
                    return true;
                } catch (e) { console.error("Error BD:", e); return false; }
            }
            createTables() {
                this.db.run(`CREATE TABLE IF NOT EXISTS users (id INTEGER PRIMARY KEY, name TEXT); CREATE TABLE IF NOT EXISTS results (id INTEGER PRIMARY KEY, user_id INTEGER, game_type TEXT, category TEXT, score INTEGER, timestamp INTEGER);`);
                this.save();
            }
            save() {
                localStorage.setItem("neuroactive_v2_db", JSON.stringify(Array.from(this.db.export())));
            }
            loginUser(name) {
                let stmt = this.db.prepare("SELECT id, name FROM users WHERE name = :name");
                let user = stmt.getAsObject({':name': name});
                stmt.free();
                if (!user.id) {
                    this.db.run("INSERT INTO users (name) VALUES (?)", [name]);
                    this.save();
                    const res = this.db.exec("SELECT last_insert_rowid()");
                    user = { id: res[0].values[0][0], name: name };
                }
                return user;
            }
            saveResult(userId, gameType, score) {
                const category = GAME_CONFIG[gameType] ? GAME_CONFIG[gameType].category : 'General';
                this.db.run("INSERT INTO results (user_id, game_type, category, score, timestamp) VALUES (?, ?, ?, ?, ?)", [userId, gameType, category, score, Date.now()]);
                this.save();
            }
            getStats(userId) {
                const totalRes = this.db.exec(`SELECT SUM(score) FROM results WHERE user_id = ${userId}`);
                const totalScore = totalRes[0]?.values[0][0] || 0;
                const catRes = this.db.exec(`SELECT category, SUM(score) FROM results WHERE user_id = ${userId} GROUP BY category`);
                const categoryScores = { 'Memoria': 0, 'Atenci√≥n': 0, 'Lenguaje': 0, 'Velocidad': 0 };
                if(catRes.length > 0) catRes[0].values.forEach(row => { categoryScores[row[0]] = row[1]; });
                const sevenDaysAgo = Date.now() - (7 * 24 * 60 * 60 * 1000);
                const dailyRes = this.db.exec(`SELECT timestamp, score FROM results WHERE user_id = ${userId} AND timestamp > ${sevenDaysAgo}`);
                const dailyScores = {};
                if (dailyRes.length > 0) dailyRes[0].values.forEach(row => {
                    const date = new Date(row[0]).toLocaleDateString(undefined, {weekday: 'short'});
                    dailyScores[date] = (dailyScores[date] || 0) + row[1];
                });
                return { totalScore, categoryScores, dailyScores };
            }
        }

        class GameEngine {
            constructor(container, msgEl, onScore, onEnd) {
                this.container = container;
                this.msgEl = msgEl;
                this.onScore = onScore;
                this.onEnd = onEnd;
                this.score = 0;
                this.level = 1;
                this.active = false;
            }
            clear() { this.container.innerHTML = ''; }
            message(text, color='text-gray-700') { 
                this.msgEl.className = `mt-4 text-xl text-center font-bold ${color} px-4 transition-all duration-300`;
                this.msgEl.innerText = text; 
            }
            end() { this.active = false; this.onEnd(this.score); }
        }

        class MemoryMatrixGame extends GameEngine {
            start() { this.score = 0; this.level = 1; this.next(); }
            next() {
                this.clear();
                this.active = false;
                this.message(`Nivel ${this.level}: Memoriza`);
                
                let size = this.level < 3 ? 3 : (this.level < 6 ? 4 : 5);
                let count = 2 + Math.floor(this.level/2);

                this.container.className = "w-full max-w-xs grid gap-2 mx-auto transition-all duration-300";
                this.container.style.gridTemplateColumns = `repeat(${size}, 1fr)`;

                let cells = [];
                for(let i=0; i<size*size; i++) {
                    let d = document.createElement('div');
                    d.className = 'bg-gray-200 w-full aspect-square rounded-lg cursor-pointer transition-all duration-200 hover:brightness-95';
                    d.onclick = () => this.click(i, d);
                    this.container.appendChild(d);
                    cells.push(d);
                }

                let pattern = [];
                while(pattern.length < count) {
                    let r = Math.floor(Math.random()*(size*size));
                    if(!pattern.includes(r)) pattern.push(r);
                }
                this.pattern = pattern;
                this.userPattern = [];

                setTimeout(() => {
                    pattern.forEach(i => cells[i].classList.replace('bg-gray-200', 'bg-neuro-primary'));
                    setTimeout(() => {
                        pattern.forEach(i => cells[i].classList.replace('bg-neuro-primary', 'bg-gray-200'));
                        this.active = true;
                        this.message("¬°Repite el patr√≥n!");
                    }, 1000 + (this.level * 200));
                }, 500);
            }
            click(i, el) {
                if(!this.active || this.userPattern.includes(i)) return;
                
                if(this.pattern.includes(i)) {
                    el.classList.replace('bg-gray-200', 'bg-neuro-secondary');
                    this.userPattern.push(i);
                    if(this.userPattern.length === this.pattern.length) {
                        this.score += (10 * this.level);
                        this.onScore(this.score);
                        this.level++;
                        this.active = false;
                        setTimeout(() => this.next(), 800);
                    }
                } else {
                    el.classList.replace('bg-gray-200', 'bg-neuro-danger');
                    this.message("¬°Incorrecto!", 'text-red-500');
                    setTimeout(() => this.end(), 1200);
                }
            }
        }

        class SpatialPathGame extends GameEngine {
            start() { this.score = 0; this.level = 1; this.next(); }
            async next() {
                this.clear();
                this.active = false;
                this.message(`Nivel ${this.level}`);

                this.container.className = "w-full max-w-[280px] grid grid-cols-3 gap-4 mx-auto";
                
                let cells = [];
                for(let i=0; i<9; i++) {
                    let d = document.createElement('div');
                    d.className = 'bg-gray-100 border-2 border-gray-200 w-full aspect-square rounded-full shadow-sm cursor-pointer transition-transform active:scale-90';
                    d.onclick = () => this.click(i, d);
                    this.container.appendChild(d);
                    cells.push(d);
                }

                let length = 2 + Math.floor(this.level/2);
                this.sequence = [];
                for(let i=0; i<length; i++) this.sequence.push(Math.floor(Math.random()*9));
                this.userStep = 0;

                await new Promise(r => setTimeout(r, 500));
                
                for(let idx of this.sequence) {
                    cells[idx].classList.add('bg-neuro-primary', 'scale-110', 'border-blue-600');
                    await new Promise(r => setTimeout(r, 600));
                    cells[idx].classList.remove('bg-neuro-primary', 'scale-110', 'border-blue-600');
                    await new Promise(r => setTimeout(r, 200));
                }
                this.active = true;
                this.message("Tu turno");
            }
            click(i, el) {
                if(!this.active) return;
                el.classList.add('bg-yellow-200');
                setTimeout(()=>el.classList.remove('bg-yellow-200'), 150);

                if(i === this.sequence[this.userStep]) {
                    this.userStep++;
                    if(this.userStep >= this.sequence.length) {
                        this.score += 20;
                        this.onScore(this.score);
                        this.level++;
                        this.active = false;
                        setTimeout(() => this.next(), 800);
                    }
                } else {
                    this.message("Error de secuencia", "text-red-500");
                    setTimeout(() => this.end(), 1200);
                }
            }
        }

        class StroopGame extends GameEngine {
            start() { this.score = 0; this.rounds = 0; this.next(); }
            next() {
                this.clear();
                if(this.rounds >= 10) return this.end();
                this.message("¬øDe qu√© COLOR es la tinta?");
                
                const colors = [
                    {n:'ROJO', c:'text-red-500'}, {n:'AZUL', c:'text-blue-500'}, {n:'VERDE', c:'text-green-500'}
                ];
                let txtIdx = Math.floor(Math.random()*3);
                let colIdx = Math.random() > 0.4 ? (txtIdx + 1)%3 : txtIdx;
                
                this.container.className = "flex flex-col items-center w-full";

                let word = document.createElement('div');
                word.innerText = colors[txtIdx].n;
                word.className = `text-5xl md:text-7xl font-black mb-8 mt-4 ${colors[colIdx].c}`;
                this.container.appendChild(word);

                let btnCont = document.createElement('div');
                btnCont.className = "grid grid-cols-3 gap-2 w-full";
                colors.forEach((c, i) => {
                    let b = document.createElement('button');
                    b.innerText = c.n;
                    b.className = "py-4 bg-gray-50 border-2 border-gray-200 rounded-xl font-bold text-gray-700 active:bg-gray-200 active:scale-95 transition-all text-sm md:text-base";
                    b.onclick = () => {
                        if(i === colIdx) {
                            this.score += 15;
                            this.onScore(this.score);
                            this.message("¬°Bien!", "text-green-500");
                        } else {
                            this.message("Fallaste", "text-red-500");
                        }
                        this.rounds++;
                        setTimeout(() => this.next(), 600);
                    }
                    btnCont.appendChild(b);
                });
                this.container.appendChild(btnCont);
            }
        }

        class GoNoGoGame extends GameEngine {
            start() {
                this.score = 0; this.rounds = 0; 
                this.container.className = "flex flex-col items-center justify-center w-full h-full";
                this.container.innerHTML = `
                    <div id="stimulus" class="w-32 h-32 md:w-40 md:h-40 rounded-2xl bg-gray-200 mb-8 transition-all duration-200"></div>
                    <button id="go-btn" class="w-full max-w-xs bg-neuro-primary text-white py-5 rounded-2xl text-2xl font-bold shadow-lg active:scale-95 touch-manipulation">¬°PULSAR!</button>
                `;
                this.stimulus = document.getElementById('stimulus');
                this.btn = document.getElementById('go-btn');
                this.btn.onclick = () => this.handleClick();
                this.next();
            }
            next() {
                if(this.rounds >= 15) return this.end();
                this.stimulus.className = "w-32 h-32 md:w-40 md:h-40 rounded-2xl bg-gray-200 mb-8";
                this.message("Espera al VERDE...");
                
                setTimeout(() => {
                    if(!this.active && this.rounds < 15) {
                        this.active = true;
                        this.isTarget = Math.random() > 0.3;
                        if(this.isTarget) {
                            this.stimulus.className = "w-32 h-32 md:w-40 md:h-40 rounded-md bg-green-500 mb-8 shadow-xl scale-110";
                        } else {
                            this.stimulus.className = "w-32 h-32 md:w-40 md:h-40 rounded-full bg-red-500 mb-8 shadow-xl";
                        }
                        this.timeout = setTimeout(() => {
                            if(this.active) {
                                if(this.isTarget) this.message("¬°Lento!", "text-orange-500");
                                else { 
                                    this.score += 5; 
                                    this.onScore(this.score);
                                    this.message("Bien (Inhibici√≥n)", "text-green-500");
                                }
                                this.finishRound();
                            }
                        }, 1500);
                    }
                }, 1000 + Math.random()*1500);
            }
            handleClick() {
                if(!this.active) return;
                clearTimeout(this.timeout);
                if(this.isTarget) {
                    this.score += 15;
                    this.onScore(this.score);
                    this.message("¬°Excelente!", "text-green-500");
                } else {
                    this.score -= 5;
                    this.onScore(this.score);
                    this.message("¬°NO!", "text-red-500");
                }
                this.finishRound();
            }
            finishRound() {
                this.active = false;
                this.rounds++;
                setTimeout(() => this.next(), 800);
            }
        }

        class LanguageOrderGame extends GameEngine {
            start() {
                this.score = 0; this.qIdx = 0;
                this.phrases = ["El cielo es azul", "Me gusta el pan", "Hoy hace sol", "El perro corre", "La flor es roja"];
                this.next();
            }
            next() {
                this.clear();
                if(this.qIdx >= this.phrases.length) return this.end();
                
                let target = this.phrases[this.qIdx];
                let words = target.split(' ').sort(() => Math.random()-0.5);
                let current = [];

                this.message("Forma la frase:");
                this.container.className = "w-full max-w-md flex flex-col";

                let zone = document.createElement('div');
                zone.className = "w-full min-h-[70px] bg-blue-50 border-2 border-dashed border-blue-200 rounded-xl mb-6 flex flex-wrap gap-2 p-3 justify-center items-center transition-all";
                this.container.appendChild(zone);

                let bank = document.createElement('div');
                bank.className = "flex flex-wrap gap-2 justify-center content-start";
                
                words.forEach(w => {
                    let b = document.createElement('button');
                    b.innerText = w;
                    b.className = "bg-white border shadow-sm px-4 py-2 rounded-lg text-lg font-medium active:scale-95 transition-transform";
                    b.onclick = () => {
                        if(b.parentElement === bank) {
                            zone.appendChild(b);
                            current.push(w);
                        } else {
                            bank.appendChild(b);
                            current.splice(current.indexOf(w), 1);
                        }
                        if(current.join(' ') === target) {
                            this.score += 20;
                            this.onScore(this.score);
                            this.message("¬°Perfecto!", "text-green-500");
                            this.qIdx++;
                            setTimeout(() => this.next(), 800);
                        }
                    };
                    bank.appendChild(b);
                });
                this.container.appendChild(bank);
            }
        }

        class WordAssocGame extends GameEngine {
            start() {
                this.score = 0; this.qIdx = 0;
                this.data = [
                    { type: "SIN√ìNIMO", w: "ALEGRE", opt: ["Triste", "Feliz", "R√°pido"], ans: 1 },
                    { type: "ANT√ìNIMO", w: "CALIENTE", opt: ["Fr√≠o", "Fuego", "Tibio"], ans: 0 },
                    { type: "SIN√ìNIMO", w: "AUTO", opt: ["Rueda", "Coche", "Camino"], ans: 1 },
                    { type: "ANT√ìNIMO", w: "LLENO", opt: ["Vac√≠o", "Todo", "Alto"], ans: 0 }
                ];
                this.next();
            }
            next() {
                this.clear();
                if(this.qIdx >= this.data.length) return this.end();
                
                let q = this.data[this.qIdx];
                this.message(`Busca el ${q.type} de:`);
                this.container.className = "flex flex-col items-center w-full";

                let main = document.createElement('div');
                main.innerText = q.w;
                main.className = "text-4xl font-black text-neuro-primary mb-6";
                this.container.appendChild(main);

                let grid = document.createElement('div');
                grid.className = "grid grid-cols-1 gap-3 w-full max-w-xs";
                
                q.opt.forEach((opt, i) => {
                    let b = document.createElement('button');
                    b.innerText = opt;
                    b.className = "bg-white border-2 border-gray-100 p-4 rounded-xl text-xl shadow-sm hover:border-blue-300 active:bg-blue-50 transition-colors";
                    b.onclick = () => {
                        if(i === q.ans) {
                            this.score += 15;
                            this.onScore(this.score);
                            this.message("Correcto", "text-green-500");
                        } else {
                            this.message("Incorrecto", "text-red-500");
                        }
                        this.qIdx++;
                        setTimeout(() => this.next(), 800);
                    };
                    grid.appendChild(b);
                });
                this.container.appendChild(grid);
            }
        }

        class SymbolSearchGame extends GameEngine {
            start() {
                this.score = 0; this.timeLeft = 30; 
                this.active = true;
                
                this.timerInt = setInterval(() => {
                    this.timeLeft--;
                    this.message(`Tiempo: ${this.timeLeft}s`, "text-purple-600");
                    if(this.timeLeft <= 0) {
                        clearInterval(this.timerInt);
                        this.end();
                    }
                }, 1000);
                this.renderGrid();
            }
            renderGrid() {
                this.clear();
                if(!this.active) return;
                
                const symbols = ['‚òÖ', '‚óè', '‚ñ†', '‚ñ≤', '‚ô¶', '‚ô•'];
                const target = symbols[Math.floor(Math.random()*symbols.length)];
                
                this.container.className = "flex flex-col items-center w-full max-w-sm mx-auto";

                let info = document.createElement('div');
                info.innerHTML = `Busca: <span class="text-5xl font-bold text-neuro-primary align-middle ml-2">${target}</span>`;
                info.className = "mb-6 text-xl flex items-center";
                this.container.appendChild(info);

                let grid = document.createElement('div');
                grid.className = "grid grid-cols-4 gap-3 w-full";
                
                let items = [];
                for(let i=0; i<15; i++) {
                    let s = symbols[Math.floor(Math.random()*symbols.length)];
                    if(s === target) s = symbols[(symbols.indexOf(s)+1)%symbols.length];
                    items.push({s: s, isT: false});
                }
                items.push({s: target, isT: true});
                items.sort(() => Math.random()-0.5);

                items.forEach(item => {
                    let b = document.createElement('button');
                    b.innerText = item.s;
                    b.className = "w-full aspect-square bg-gray-50 border border-gray-200 rounded-xl text-3xl flex items-center justify-center shadow-sm active:bg-gray-200 transition-colors";
                    b.onclick = () => {
                        if(item.isT) {
                            this.score += 5;
                            this.onScore(this.score);
                            this.renderGrid();
                        } else {
                            b.classList.add('bg-red-100', 'border-red-300');
                            setTimeout(()=>b.classList.remove('bg-red-100', 'border-red-300'), 200);
                        }
                    };
                    grid.appendChild(b);
                });
                this.container.appendChild(grid);
            }
            end() {
                clearInterval(this.timerInt);
                super.end();
            }
        }

        class App {
            constructor() {
                this.db = new DatabaseManager();
                this.user = null;
                this.charts = {};
            }
            async init() {
                await this.db.init();
                const uid = localStorage.getItem('na_uid');
                const uname = localStorage.getItem('na_uname');
                if(uid && uname) this.setUser({id:uid, name:uname});
                
                document.getElementById('btn-login').onclick = () => {
                    const name = document.getElementById('input-username').value.trim();
                    if(name) {
                        const u = this.db.loginUser(name);
                        localStorage.setItem('na_uid', u.id);
                        localStorage.setItem('na_uname', u.name);
                        this.setUser(u);
                    }
                };
            }
            setUser(u) {
                this.user = u;
                document.getElementById('header-username').innerText = u.name;
                document.getElementById('user-badge').classList.remove('hidden');
                document.getElementById('view-login').classList.add('hidden');
                document.getElementById('nav-tabs').classList.remove('hidden');
                this.switchTab('home');
            }
            logout() {
                localStorage.removeItem('na_uid');
                localStorage.removeItem('na_uname');
                location.reload();
            }
            switchTab(tab) {
                ['home', 'stats', 'game'].forEach(v => document.getElementById(`view-${v}`).classList.add('hidden'));
                
                // Reset tab styles
                document.getElementById('tab-home').className = "flex flex-col items-center p-2 w-full text-gray-400 transition duration-200 rounded-lg active:bg-gray-50";
                document.getElementById('tab-stats').className = "flex flex-col items-center p-2 w-full text-gray-400 transition duration-200 rounded-lg active:bg-gray-50";

                if(tab === 'home') {
                    document.getElementById('view-home').classList.remove('hidden');
                    document.getElementById('tab-home').className = "flex flex-col items-center p-2 w-full text-neuro-primary transition duration-200 rounded-lg active:bg-gray-50";
                }
                if(tab === 'stats') {
                    document.getElementById('view-stats').classList.remove('hidden');
                    document.getElementById('tab-stats').className = "flex flex-col items-center p-2 w-full text-neuro-primary transition duration-200 rounded-lg active:bg-gray-50";
                    this.loadStats();
                }
            }
            startGame(type) {
                document.getElementById('view-home').classList.add('hidden');
                document.getElementById('view-game').classList.remove('hidden');
                document.getElementById('game-score').innerText = '0';
                
                const area = document.getElementById('game-area');
                const msg = document.getElementById('game-message');
                area.innerHTML = ''; // Limpiar previo
                msg.innerHTML = 'Cargando...'; // Limpiar mensaje previo

                const onScore = (s) => document.getElementById('game-score').innerText = s;
                const onEnd = (s) => {
                    this.db.saveResult(this.user.id, type, s);
                    alert(`¬°Fin del juego!\nPuntos: ${s}`);
                    this.switchTab('home');
                };

                const games = {
                    memoryMatrix: MemoryMatrixGame,
                    spatialPath: SpatialPathGame,
                    stroop: StroopGame,
                    goNoGo: GoNoGoGame,
                    languageOrder: LanguageOrderGame,
                    wordAssoc: WordAssocGame,
                    symbolSearch: SymbolSearchGame
                };

                if(games[type]) {
                    this.game = new games[type](area, msg, onScore, onEnd);
                    this.game.start();
                }
            }
            loadStats() {
                const data = this.db.getStats(this.user.id);
                document.getElementById('global-score').innerText = data.totalScore;

                const ctxRadar = document.getElementById('radarChart');
                if(this.charts.radar) this.charts.radar.destroy();
                this.charts.radar = new Chart(ctxRadar, {
                    type: 'radar',
                    data: {
                        labels: ['Memoria', 'Atenci√≥n', 'Lenguaje', 'Velocidad'],
                        datasets: [{
                            label: 'Nivel',
                            data: [data.categoryScores['Memoria'], data.categoryScores['Atenci√≥n'], data.categoryScores['Lenguaje'], data.categoryScores['Velocidad']],
                            backgroundColor: 'rgba(37, 99, 235, 0.2)', borderColor: '#2563EB', pointBackgroundColor: '#2563EB'
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, scales: { r: { beginAtZero: true, suggestedMax: 100 } } }
                });

                const ctxLine = document.getElementById('lineChart');
                if(this.charts.line) this.charts.line.destroy();
                this.charts.line = new Chart(ctxLine, {
                    type: 'line',
                    data: {
                        labels: Object.keys(data.dailyScores),
                        datasets: [{ label: 'Puntos', data: Object.values(data.dailyScores), borderColor: '#10B981', tension: 0.4 }]
                    },
                    options: { responsive: true, maintainAspectRatio: false }
                });
            }
        }

        const app = new App();
        window.onload = () => app.init();
    </script>
</body>
</html>